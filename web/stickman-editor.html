<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è“æ³¢çƒçš„ç«æŸ´äººä¸åŠ¨ç‰©ï¼ˆå…¨å±ç”»å¸ƒç‰ˆï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background-color: #f5f5f5;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        .header {
            padding: 10px 20px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .title {
            color: #333;
            margin-bottom: 5px;
        }
        .instructions {
            color: #666;
            font-size: 14px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .control-panel {
            padding: 10px 20px;
            background-color: #fff;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            z-index: 10;
            min-height: fit-content;
        }
        .stickman-selector {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            min-width: 180px;
        }
        .type-selector {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            min-width: 150px;
        }
        .control-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 3px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .control-btn.add {
            background-color: #34a853;
        }
        .control-btn.add:hover {
            background-color: #2d974b;
        }
        .control-btn.reset {
            background-color: #ea4335;
        }
        .control-btn.reset:hover {
            background-color: #d93025;
        }
        .control-btn.delete {
            background-color: #ff9800;
        }
        .control-btn.delete:hover {
            background-color: #f57c00;
        }
        .control-btn.export {
            background-color: #ff5722;
        }
        .control-btn.export:hover {
            background-color: #e64a19;
        }
        .canvas-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
            flex-wrap: wrap;
        }
        .size-input {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .control-btn.canvas {
            background-color: #9c27b0;
        }
        .control-btn.canvas:hover {
            background-color: #7b1fa2;
        }
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
        }
        .zoom-btn {
            padding: 4px 8px;
            background-color: #4285f4;
        }
        .zoom-btn:hover {
            background-color: #3367d6;
        }
        .zoom-level {
            min-width: 60px;
            text-align: center;
            font-size: 14px;
        }
        .main-container {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }
        #canvasContainer {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: #fff;
        }
        canvas {
            cursor: default;
            display: block;
        }
        canvas.dragging {
            cursor: grabbing;
        }
        .status-indicator {
            position: absolute;
            bottom: 10px;
            left: 10px;
            padding: 5px 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 3px;
            color: #333;
            font-size: 14px;
            z-index: 5;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .selected-indicator {
            position: absolute;
            border: 2px dashed #4285f4;
            border-radius: 6px;
            pointer-events: none;
            display: none;
            z-index: 4;
        }
        .tooltip {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2 class="title">è“æ³¢çƒçš„ç«æŸ´äººä¸åŠ¨ç‰©</h2>
        <div class="instructions">
            <span>è§’è‰²æ“ä½œï¼šç‚¹å‡»é€‰æ‹© â†’ æ‹–æ‹½ç§»åŠ¨ â†’ æ»šè½®ç¼©æ”¾è§’è‰² â†’ ç‚¹å‡»å…³èŠ‚è°ƒæ•´</span>
            <span>ç”»å¸ƒæ“ä½œï¼šæŒ‰ä½ç©ºæ ¼+æ‹–æ‹½ç§»åŠ¨ â†’ æ»šè½®ï¼ˆç©ºå¤„ï¼‰ç¼©æ”¾ç”»å¸ƒ â†’ ç‚¹å‡»ç©ºç™½å–æ¶ˆé€‰æ‹©</span>
        </div>
    </div>
    
    <div class="control-panel">
        <select class="type-selector" id="typeSelector">
            <option value="human">ç«æŸ´äººï¼ˆäººç±»ï¼‰</option>
            <option value="horse">é©¬</option>
            <option value="elephant">å¤§è±¡</option>
            <option value="cat">çŒ«</option>
            <option value="dog">ç‹—</option>
            <option value="bird">é¸Ÿ</option>
            <option value="snake">è›‡</option>
            <option value="dragon">é¾™</option>
            <option value="sheep">ç¾Š</option>
            <option value="rabbit">å…”å­</option>
            <option value="giraffe">é•¿é¢ˆé¹¿</option>
            <option value="panda">ç†ŠçŒ«</option>
            <option value="chicken">é¸¡</option>
            <option value="cow">ç‰›</option>
            <option value="mouse">è€é¼ </option>
        </select>
        <select class="stickman-selector" id="stickmanSelector">
            <option value="-1">æœªé€‰æ‹©ä»»ä½•è§’è‰²</option>
        </select>
        <button class="control-btn add" id="addStickmanBtn">å¢åŠ è§’è‰²</button>
        <button class="control-btn reset" id="resetBtn">é€‰ä¸­è§’è‰²å§¿æ€å½’é›¶</button>
        <button class="control-btn delete" id="deleteStickmanBtn">åˆ é™¤é€‰ä¸­è§’è‰²</button>
        
        <div class="canvas-controls">
            <input type="number" class="size-input" id="canvasWidth" placeholder="å®½åº¦" value="1920">
            <span>Ã—</span>
            <input type="number" class="size-input" id="canvasHeight" placeholder="é«˜åº¦" value="1080">
            <button class="control-btn canvas" id="resizeCanvasBtn">è°ƒæ•´ç”»å¸ƒ</button>
            
            <div class="zoom-controls">
                <button class="control-btn zoom-btn" id="zoomOutBtn">-</button>
                <span class="zoom-level" id="zoomLevel">100%</span>
                <button class="control-btn zoom-btn" id="zoomInBtn">+</button>
                <button class="control-btn canvas" id="resetViewBtn">é‡ç½®è§†å›¾</button>
                <button class="control-btn export" id="exportImageBtn">ğŸ“¥ å¯¼å‡ºå›¾åƒ</button>
            </div>
        </div>
    </div>
    
    <div class="main-container">
        <div id="canvasContainer">
            <div class="selected-indicator" id="selectedIndicator"></div>
            <canvas id="stickmanCanvas" width="1920" height="1080"></canvas>
        </div>
        <div class="status-indicator" id="statusText">
            çŠ¶æ€ï¼šæœªé€‰æ‹©ä»»ä½•è§’è‰²ï¼ˆç‚¹å‡»"å¢åŠ è§’è‰²"æ·»åŠ è§’è‰²ï¼‰
        </div>
    </div>

    <script>
        const canvas = document.getElementById('stickmanCanvas');
        const ctx = canvas.getContext('2d');
        const canvasContainer = document.getElementById('canvasContainer');
        const selectedIndicator = document.getElementById('selectedIndicator');
        const stickmanSelector = document.getElementById('stickmanSelector');
        const typeSelector = document.getElementById('typeSelector');
        const statusText = document.getElementById('statusText');
        const canvasWidthInput = document.getElementById('canvasWidth');
        const canvasHeightInput = document.getElementById('canvasHeight');
        const zoomLevelDisplay = document.getElementById('zoomLevel');
        
        // æŒ‰é’®å…ƒç´ 
        const addStickmanBtn = document.getElementById('addStickmanBtn');
        const resetBtn = document.getElementById('resetBtn');
        const deleteStickmanBtn = document.getElementById('deleteStickmanBtn');
        const resizeCanvasBtn = document.getElementById('resizeCanvasBtn');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const resetViewBtn = document.getElementById('resetViewBtn');
        const exportImageBtn = document.getElementById('exportImageBtn');
        
        // å¯¼å‡ºçŠ¶æ€æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        let isExporting = false;

        // è§’è‰²é¢œè‰²åº“
        const stickmanColors = [
            { line: '#333', joint: '#ff4757', jointDrag: '#ff6b6b', name: 'çº¢è‰²' },
            { line: '#1a73e8', joint: '#4285f4', jointDrag: '#73a7ff', name: 'è“è‰²' },
            { line: '#34a853', joint: '#34a853', jointDrag: '#66c285', name: 'ç»¿è‰²' },
            { line: '#fbbc05', joint: '#fbbc05', jointDrag: '#ffce47', name: 'é»„è‰²' },
            { line: '#8e24aa', joint: '#ba68c8', jointDrag: '#ce93d8', name: 'ç´«è‰²' },
            { line: '#ff6b81', joint: '#ff8fa3', jointDrag: '#ffb3c1', name: 'ç²‰è‰²' },
            { line: '#70a1ff', joint: '#93bfff', jointDrag: '#b8d4ff', name: 'æµ…è“' },
            { line: '#2ed573', joint: '#54e08d', jointDrag: '#7be8a5', name: 'æµ…ç»¿' },
            { line: '#ff7f50', joint: '#ff9e7d', jointDrag: '#ffbea9', name: 'æ©™è‰²' },
            { line: '#607d8b', joint: '#8dabc4', jointDrag: '#b9cad9', name: 'ç°è‰²' },
            { line: '#ff4081', joint: '#ff77a9', jointDrag: '#ffb8d1', name: 'ç«çº¢' },
            { line: '#00acc1', joint: '#4dd0e1', jointDrag: '#80deea', name: 'é’è“' },
            { line: '#7cb342', joint: '#aed581', jointDrag: '#dcedc8', name: 'è‰ç»¿' },
            { line: '#ffca28', joint: '#ffee58', jointDrag: '#fff9c4', name: 'äº®é»„' },
            { line: '#455a64', joint: '#607d8b', jointDrag: '#90a4ae', name: 'æ·±ç°' }
        ];

        // è§’è‰²ç±»å‹é…ç½®ï¼ˆåŒ…å«ç«æŸ´äººå’Œ14ç§åŠ¨ç‰©ï¼‰
        const characterTypes = {
            // ç«æŸ´äººï¼ˆäººç±»ï¼‰
            human: {
                name: "ç«æŸ´äºº",
                joints: [
                    { x: 300, y: 150, r: 20, isDragging: false }, // å¤´éƒ¨
                    { x: 300, y: 220, r: 8, isDragging: false },  // é¢ˆéƒ¨
                    { x: 300, y: 280, r: 8, isDragging: false },  // ä¸Šèº¯å¹²
                    { x: 300, y: 360, r: 8, isDragging: false },  // ä¸‹èº¯å¹²
                    { x: 250, y: 250, r: 8, isDragging: false },  // å·¦è‚©
                    { x: 350, y: 250, r: 8, isDragging: false },  // å³è‚©
                    { x: 180, y: 280, r: 8, isDragging: false },  // å·¦è‚˜
                    { x: 420, y: 280, r: 8, isDragging: false },  // å³è‚˜
                    { x: 120, y: 290, r: 8, isDragging: false },  // å·¦æ‰‹
                    { x: 480, y: 290, r: 8, isDragging: false },  // å³æ‰‹
                    { x: 250, y: 450, r: 8, isDragging: false },  // å·¦è†
                    { x: 350, y: 450, r: 8, isDragging: false },  // å³è†
                    { x: 220, y: 580, r: 8, isDragging: false },  // å·¦è„š
                    { x: 380, y: 580, r: 8, isDragging: false }   // å³è„š
                ],
                connections: [
                    [0, 1], [1, 2], [2, 3], // èº¯å¹²
                    [1, 4], [4, 6], [6, 8], // å·¦è‡‚
                    [1, 5], [5, 7], [7, 9], // å³è‡‚
                    [3, 10], [10, 12],      // å·¦è…¿
                    [3, 11], [11, 13]       // å³è…¿
                ]
            },
            // é©¬
            horse: {
                name: "é©¬",
                joints: [
                    { x: 300, y: 200, r: 18, isDragging: false }, // å¤´éƒ¨
                    { x: 300, y: 250, r: 8, isDragging: false },  // é¢ˆéƒ¨
                    { x: 300, y: 300, r: 10, isDragging: false }, // èº¯å¹²
                    { x: 300, y: 350, r: 9, isDragging: false },  // åèº¯
                    { x: 260, y: 270, r: 8, isDragging: false },  // å·¦è‚©
                    { x: 340, y: 270, r: 8, isDragging: false },  // å³è‚©
                    { x: 220, y: 400, r: 8, isDragging: false },  // å·¦å‰è…¿
                    { x: 380, y: 400, r: 8, isDragging: false },  // å³å‰è…¿
                    { x: 250, y: 380, r: 8, isDragging: false },  // å·¦åèƒ¯
                    { x: 350, y: 380, r: 8, isDragging: false },  // å³åèƒ¯
                    { x: 210, y: 480, r: 8, isDragging: false },  // å·¦åè…¿
                    { x: 390, y: 480, r: 8, isDragging: false },  // å³åè…¿
                    { x: 300, y: 420, r: 7, isDragging: false },  // å°¾å·´æ ¹
                    { x: 300, y: 460, r: 6, isDragging: false },  // å°¾å·´ä¸­
                    { x: 300, y: 500, r: 5, isDragging: false },  // å°¾å·´å°–
                    { x: 280, y: 210, r: 5, isDragging: false },  // å·¦è€³
                    { x: 320, y: 210, r: 5, isDragging: false },  // å³è€³
                    { x: 300, y: 220, r: 6, isDragging: false },  // é¬ƒæ¯›1
                    { x: 300, y: 235, r: 6, isDragging: false }   // é¬ƒæ¯›2
                ],
                connections: [
                    [0, 1], [1, 2], [2, 3], // èº¯å¹²
                    [0, 15], [0, 16],       // è€³æœµ
                    [1, 17], [17, 18],      // é¬ƒæ¯›
                    [2, 4], [4, 6],         // å·¦å‰è…¿
                    [2, 5], [5, 7],         // å³å‰è…¿
                    [3, 8], [8, 10],        // å·¦åè…¿
                    [3, 9], [9, 11],        // å³åè…¿
                    [3, 12], [12, 13], [13, 14] // å°¾å·´
                ]
            },
            // å¤§è±¡
            elephant: {
                name: "å¤§è±¡",
                joints: [
                    { x: 300, y: 220, r: 25, isDragging: false }, // å¤´éƒ¨ï¼ˆå¤§ï¼‰
                    { x: 300, y: 280, r: 12, isDragging: false }, // é¢ˆéƒ¨
                    { x: 300, y: 350, r: 15, isDragging: false }, // èº¯å¹²ï¼ˆç²—å£®ï¼‰
                    { x: 300, y: 420, r: 12, isDragging: false }, // åèº¯
                    { x: 250, y: 320, r: 12, isDragging: false }, // å·¦è‚©ï¼ˆç²—å£®ï¼‰
                    { x: 350, y: 320, r: 12, isDragging: false }, // å³è‚©ï¼ˆç²—å£®ï¼‰
                    { x: 220, y: 450, r: 10, isDragging: false }, // å·¦å‰è…¿
                    { x: 380, y: 450, r: 10, isDragging: false }, // å³å‰è…¿
                    { x: 240, y: 460, r: 12, isDragging: false }, // å·¦åèƒ¯ï¼ˆç²—å£®ï¼‰
                    { x: 360, y: 460, r: 12, isDragging: false }, // å³åèƒ¯ï¼ˆç²—å£®ï¼‰
                    { x: 210, y: 550, r: 10, isDragging: false }, // å·¦åçˆª
                    { x: 390, y: 550, r: 10, isDragging: false }, // å³åçˆª
                    { x: 300, y: 220, r: 8, isDragging: false },  // é¼»å­æ ¹
                    { x: 300, y: 300, r: 6, isDragging: false },  // é¼»å­ä¸­
                    { x: 300, y: 350, r: 5, isDragging: false },  // é¼»å­å°–
                    { x: 230, y: 250, r: 10, isDragging: false }, // å·¦è€³ï¼ˆå¤§ï¼‰
                    { x: 370, y: 250, r: 10, isDragging: false }  // å³è€³ï¼ˆå¤§ï¼‰
                ],
                connections: [
                    [0, 1], [1, 2], [2, 3], // èº¯å¹²
                    [0, 12], [12, 13], [13, 14], // é•¿é¼»å­
                    [0, 15], [0, 16],       // å¤§è€³æœµ
                    [2, 4], [4, 6],         // å·¦å‰è…¿ï¼ˆç²—å£®ï¼‰
                    [2, 5], [5, 7],         // å³å‰è…¿ï¼ˆç²—å£®ï¼‰
                    [3, 8], [8, 10],        // å·¦åè…¿ï¼ˆç²—å£®ï¼‰
                    [3, 9], [9, 11],        // å³åè…¿ï¼ˆç²—å£®ï¼‰
                ]
            },
            // çŒ«
            cat: {
                name: "çŒ«",
                joints: [
                    { x: 300, y: 200, r: 18, isDragging: false }, // å¤´éƒ¨
                    { x: 300, y: 250, r: 8, isDragging: false },  // é¢ˆéƒ¨
                    { x: 300, y: 290, r: 8, isDragging: false },  // èº¯å¹²
                    { x: 300, y: 330, r: 8, isDragging: false },  // åèº¯
                    { x: 260, y: 270, r: 8, isDragging: false },  // å·¦è‚©
                    { x: 340, y: 270, r: 8, isDragging: false },  // å³è‚©
                    { x: 210, y: 280, r: 8, isDragging: false },  // å·¦å‰çˆª
                    { x: 390, y: 280, r: 8, isDragging: false },  // å³å‰çˆª
                    { x: 250, y: 370, r: 8, isDragging: false },  // å·¦åèƒ¯
                    { x: 350, y: 370, r: 8, isDragging: false },  // å³åèƒ¯
                    { x: 200, y: 420, r: 8, isDragging: false },  // å·¦åçˆª
                    { x: 400, y: 420, r: 8, isDragging: false },  // å³åçˆª
                    { x: 280, y: 190, r: 5, isDragging: false },  // å·¦è€³
                    { x: 320, y: 190, r: 5, isDragging: false },  // å³è€³
                    { x: 300, y: 360, r: 8, isDragging: false }   // å°¾å·´æ ¹
                ],
                connections: [
                    [0, 1], [1, 2], [2, 3], // èº¯å¹²
                    [0, 12], [0, 13],       // è€³æœµ
                    [1, 4], [4, 6],         // å·¦å‰è…¿
                    [1, 5], [5, 7],         // å³å‰è…¿
                    [3, 8], [8, 10],        // å·¦åè…¿
                    [3, 9], [9, 11],        // å³åè…¿
                    [3, 14]                 // å°¾å·´æ ¹
                ]
            },
            // ç‹—
            dog: {
                name: "ç‹—",
                joints: [
                    { x: 300, y: 200, r: 20, isDragging: false }, // å¤´éƒ¨
                    { x: 300, y: 260, r: 8, isDragging: false },  // é¢ˆéƒ¨
                    { x: 300, y: 310, r: 8, isDragging: false },  // èº¯å¹²
                    { x: 300, y: 360, r: 8, isDragging: false },  // åèº¯
                    { x: 260, y: 280, r: 8, isDragging: false },  // å·¦è‚©
                    { x: 340, y: 280, r: 8, isDragging: false },  // å³è‚©
                    { x: 210, y: 300, r: 8, isDragging: false },  // å·¦å‰çˆª
                    { x: 390, y: 300, r: 8, isDragging: false },  // å³å‰çˆª
                    { x: 250, y: 400, r: 8, isDragging: false },  // å·¦åèƒ¯
                    { x: 350, y: 400, r: 8, isDragging: false },  // å³åèƒ¯
                    { x: 190, y: 450, r: 8, isDragging: false },  // å·¦åçˆª
                    { x: 410, y: 450, r: 8, isDragging: false },  // å³åçˆª
                    { x: 300, y: 390, r: 8, isDragging: false },  // å°¾å·´æ ¹
                    { x: 300, y: 430, r: 6, isDragging: false },  // å°¾å·´ä¸­
                    { x: 300, y: 460, r: 5, isDragging: false }   // å°¾å·´å°–
                ],
                connections: [
                    [0, 1], [1, 2], [2, 3], // èº¯å¹²
                    [1, 4], [4, 6],         // å·¦å‰è…¿
                    [1, 5], [5, 7],         // å³å‰è…¿
                    [3, 8], [8, 10],        // å·¦åè…¿
                    [3, 9], [9, 11],        // å³åè…¿
                    [3, 12], [12, 13], [13, 14] // å°¾å·´
                ]
            },
            // é¸Ÿ
            bird: {
                name: "é¸Ÿ",
                joints: [
                    { x: 300, y: 200, r: 15, isDragging: false }, // å¤´éƒ¨
                    { x: 300, y: 230, r: 8, isDragging: false },  // é¢ˆéƒ¨
                    { x: 300, y: 260, r: 10, isDragging: false }, // èº¯å¹²
                    { x: 300, y: 290, r: 8, isDragging: false },  // èº«ä½“åç«¯
                    { x: 270, y: 270, r: 8, isDragging: false },  // å·¦ç¿…æ ¹
                    { x: 330, y: 270, r: 8, isDragging: false },  // å³ç¿…æ ¹
                    { x: 230, y: 260, r: 6, isDragging: false },  // å·¦ç¿…ä¸­
                    { x: 370, y: 260, r: 6, isDragging: false },  // å³ç¿…ä¸­
                    { x: 200, y: 250, r: 5, isDragging: false },  // å·¦ç¿…å°–
                    { x: 400, y: 250, r: 5, isDragging: false },  // å³ç¿…å°–
                    { x: 280, y: 310, r: 6, isDragging: false },  // å·¦è„š
                    { x: 320, y: 310, r: 6, isDragging: false },  // å³è„š
                    { x: 300, y: 300, r: 7, isDragging: false },  // å°¾ç¾½æ ¹
                    { x: 300, y: 330, r: 6, isDragging: false },  // å°¾ç¾½ä¸­
                    { x: 300, y: 350, r: 5, isDragging: false }   // å°¾ç¾½å°–
                ],
                connections: [
                    [0, 1], [1, 2], [2, 3], // èº¯å¹²
                    [2, 4], [4, 6], [6, 8], // å·¦ç¿…è†€
                    [2, 5], [5, 7], [7, 9], // å³ç¿…è†€
                    [3, 10], [3, 11],       // è„š
                    [3, 12], [12, 13], [13, 14] // å°¾ç¾½
                ]
            },
            // è›‡
            snake: {
                name: "è›‡",
                joints: [
                    { x: 300, y: 250, r: 12, isDragging: false }, // å¤´éƒ¨
                    { x: 330, y: 260, r: 10, isDragging: false }, // èº«ä½“1
                    { x: 360, y: 270, r: 10, isDragging: false }, // èº«ä½“2
                    { x: 390, y: 260, r: 10, isDragging: false }, // èº«ä½“3
                    { x: 420, y: 250, r: 10, isDragging: false }, // èº«ä½“4
                    { x: 450, y: 240, r: 10, isDragging: false }, // èº«ä½“5
                    { x: 480, y: 230, r: 10, isDragging: false }, // èº«ä½“6
                    { x: 510, y: 220, r: 10, isDragging: false }, // èº«ä½“7
                    { x: 540, y: 210, r: 9, isDragging: false },  // èº«ä½“8
                    { x: 570, y: 200, r: 8, isDragging: false },  // å°¾éƒ¨
                    { x: 290, y: 240, r: 5, isDragging: false },  // å·¦çœ¼
                    { x: 310, y: 240, r: 5, isDragging: false },  // å³çœ¼
                    { x: 300, y: 255, r: 4, isDragging: false }   // å˜´
                ],
                connections: [
                    [0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 6], [6, 7], [7, 8], [8, 9], // èº«ä½“è¿æ¥
                    [0, 10], [0, 11], [0, 12] // å¤´éƒ¨ç‰¹å¾
                ]
            },
            // é¾™
            dragon: {
                name: "é¾™",
                joints: [
                    { x: 300, y: 200, r: 20, isDragging: false }, // å¤´éƒ¨
                    { x: 300, y: 260, r: 10, isDragging: false }, // é¢ˆéƒ¨
                    { x: 300, y: 320, r: 12, isDragging: false }, // èº¯å¹²
                    { x: 300, y: 380, r: 10, isDragging: false }, // åèº¯
                    { x: 260, y: 280, r: 9, isDragging: false },  // å·¦å‰çˆªæ ¹
                    { x: 340, y: 280, r: 9, isDragging: false },  // å³å‰çˆªæ ¹
                    { x: 210, y: 320, r: 8, isDragging: false },  // å·¦å‰çˆª
                    { x: 390, y: 320, r: 8, isDragging: false },  // å³å‰çˆª
                    { x: 250, y: 420, r: 9, isDragging: false },  // å·¦åçˆªæ ¹
                    { x: 350, y: 420, r: 9, isDragging: false },  // å³åçˆªæ ¹
                    { x: 200, y: 480, r: 8, isDragging: false },  // å·¦åçˆª
                    { x: 400, y: 480, r: 8, isDragging: false },  // å³åçˆª
                    { x: 280, y: 160, r: 8, isDragging: false },  // å·¦è§’
                    { x: 320, y: 160, r: 8, isDragging: false },  // å³è§’
                    { x: 300, y: 400, r: 8, isDragging: false },  // å°¾å·´æ ¹
                    { x: 300, y: 450, r: 7, isDragging: false },  // å°¾å·´ä¸­1
                    { x: 300, y: 500, r: 6, isDragging: false },  // å°¾å·´ä¸­2
                    { x: 300, y: 550, r: 5, isDragging: false },  // å°¾å·´å°–
                    { x: 330, y: 220, r: 6, isDragging: false },  // é¾™é¡»1
                    { x: 340, y: 230, r: 5, isDragging: false }   // é¾™é¡»2
                ],
                connections: [
                    [0, 1], [1, 2], [2, 3], // èº¯å¹²
                    [0, 12], [0, 13],       // è§’
                    [0, 18], [18, 19],      // é¾™é¡»
                    [2, 4], [4, 6],         // å·¦å‰çˆª
                    [2, 5], [5, 7],         // å³å‰çˆª
                    [3, 8], [8, 10],        // å·¦åçˆª
                    [3, 9], [9, 11],        // å³åçˆª
                    [3, 14], [14, 15], [15, 16], [16, 17] // é•¿å°¾å·´
                ]
            },
            // ç¾Š
            sheep: {
                name: "ç¾Š",
                joints: [
                    { x: 300, y: 220, r: 20, isDragging: false }, // å¤´éƒ¨
                    { x: 300, y: 280, r: 10, isDragging: false }, // é¢ˆéƒ¨
                    { x: 300, y: 340, r: 12, isDragging: false }, // èº¯å¹²
                    { x: 300, y: 400, r: 10, isDragging: false }, // åèº¯
                    { x: 260, y: 310, r: 9, isDragging: false },  // å·¦è‚©
                    { x: 340, y: 310, r: 9, isDragging: false },  // å³è‚©
                    { x: 220, y: 420, r: 8, isDragging: false },  // å·¦å‰è…¿
                    { x: 380, y: 420, r: 8, isDragging: false },  // å³å‰è…¿
                    { x: 250, y: 430, r: 9, isDragging: false },  // å·¦åèƒ¯
                    { x: 350, y: 430, r: 9, isDragging: false },  // å³åèƒ¯
                    { x: 210, y: 520, r: 8, isDragging: false },  // å·¦åè…¿
                    { x: 390, y: 520, r: 8, isDragging: false },  // å³åè…¿
                    { x: 270, y: 190, r: 7, isDragging: false },  // å·¦è§’1
                    { x: 250, y: 170, r: 6, isDragging: false },  // å·¦è§’2
                    { x: 330, y: 190, r: 7, isDragging: false },  // å³è§’1
                    { x: 350, y: 170, r: 6, isDragging: false },  // å³è§’2
                    { x: 300, y: 420, r: 7, isDragging: false },  // å°¾å·´
                ],
                connections: [
                    [0, 1], [1, 2], [2, 3], // èº¯å¹²
                    [0, 12], [12, 13],      // å·¦è§’
                    [0, 14], [14, 15],      // å³è§’
                    [2, 4], [4, 6],         // å·¦å‰è…¿
                    [2, 5], [5, 7],         // å³å‰è…¿
                    [3, 8], [8, 10],        // å·¦åè…¿
                    [3, 9], [9, 11],        // å³åè…¿
                    [3, 16]                 // å°¾å·´
                ]
            },
            // å…”å­
            rabbit: {
                name: "å…”å­",
                joints: [
                    { x: 300, y: 220, r: 18, isDragging: false }, // å¤´éƒ¨
                    { x: 300, y: 260, r: 8, isDragging: false },  // é¢ˆéƒ¨
                    { x: 300, y: 300, r: 10, isDragging: false }, // èº¯å¹²
                    { x: 300, y: 340, r: 8, isDragging: false },  // åèº¯
                    { x: 270, y: 280, r: 8, isDragging: false },  // å·¦è‚©
                    { x: 330, y: 280, r: 8, isDragging: false },  // å³è‚©
                    { x: 240, y: 300, r: 7, isDragging: false },  // å·¦å‰çˆª
                    { x: 360, y: 300, r: 7, isDragging: false },  // å³å‰çˆª
                    { x: 260, y: 380, r: 10, isDragging: false }, // å·¦åèƒ¯ï¼ˆç²—å£®ï¼‰
                    { x: 340, y: 380, r: 10, isDragging: false }, // å³åèƒ¯ï¼ˆç²—å£®ï¼‰
                    { x: 230, y: 450, r: 8, isDragging: false },  // å·¦åçˆª
                    { x: 370, y: 450, r: 8, isDragging: false },  // å³åçˆª
                    { x: 270, y: 150, r: 6, isDragging: false },  // å·¦è€³ï¼ˆé•¿ï¼‰
                    { x: 330, y: 150, r: 6, isDragging: false },  // å³è€³ï¼ˆé•¿ï¼‰
                    { x: 300, y: 370, r: 5, isDragging: false }   // çŸ­å°¾å·´
                ],
                connections: [
                    [0, 1], [1, 2], [2, 3], // èº¯å¹²
                    [0, 12], [0, 13],       // é•¿è€³æœµ
                    [1, 4], [4, 6],         // å·¦å‰è…¿
                    [1, 5], [5, 7],         // å³å‰è…¿
                    [3, 8], [8, 10],        // å·¦åè…¿ï¼ˆç²—å£®ï¼‰
                    [3, 9], [9, 11],        // å³åè…¿ï¼ˆç²—å£®ï¼‰
                    [3, 14]                 // çŸ­å°¾å·´
                ]
            },
            // é•¿é¢ˆé¹¿
            giraffe: {
                name: "é•¿é¢ˆé¹¿",
                joints: [
                    { x: 300, y: 120, r: 22, isDragging: false }, // å¤´éƒ¨
                    { x: 300, y: 180, r: 10, isDragging: false }, // è„–å­1ï¼ˆé•¿ï¼‰
                    { x: 300, y: 240, r: 10, isDragging: false }, // è„–å­2ï¼ˆé•¿ï¼‰
                    { x: 300, y: 300, r: 12, isDragging: false }, // èº¯å¹²
                    { x: 300, y: 360, r: 10, isDragging: false }, // åèº¯
                    { x: 260, y: 320, r: 10, isDragging: false }, // å·¦è‚©
                    { x: 340, y: 320, r: 10, isDragging: false }, // å³è‚©
                    { x: 230, y: 500, r: 9, isDragging: false },  // å·¦å‰è…¿ï¼ˆé•¿ï¼‰
                    { x: 370, y: 500, r: 9, isDragging: false },  // å³å‰è…¿ï¼ˆé•¿ï¼‰
                    { x: 250, y: 380, r: 10, isDragging: false }, // å·¦åèƒ¯
                    { x: 350, y: 380, r: 10, isDragging: false }, // å³åèƒ¯
                    { x: 220, y: 550, r: 9, isDragging: false },  // å·¦åè…¿ï¼ˆé•¿ï¼‰
                    { x: 380, y: 550, r: 9, isDragging: false },  // å³åè…¿ï¼ˆé•¿ï¼‰
                    { x: 280, y: 110, r: 6, isDragging: false },  // å·¦è€³
                    { x: 320, y: 110, r: 6, isDragging: false },  // å³è€³
                    { x: 300, y: 390, r: 8, isDragging: false },  // å°¾å·´æ ¹
                    { x: 300, y: 430, r: 6, isDragging: false }   // å°¾å·´å°–
                ],
                connections: [
                    [0, 1], [1, 2], [2, 3], [3, 4], // é•¿è„–å­+èº¯å¹²
                    [0, 13], [0, 14],       // è€³æœµ
                    [3, 5], [5, 7],         // å·¦å‰è…¿ï¼ˆé•¿ï¼‰
                    [3, 6], [6, 8],         // å³å‰è…¿ï¼ˆé•¿ï¼‰
                    [4, 9], [9, 11],        // å·¦åè…¿ï¼ˆé•¿ï¼‰
                    [4, 10], [10, 12],      // å³åè…¿ï¼ˆé•¿ï¼‰
                    [4, 15], [15, 16]       // å°¾å·´
                ]
            },
            // ç†ŠçŒ«
            panda: {
                name: "ç†ŠçŒ«",
                joints: [
                    { x: 300, y: 220, r: 22, isDragging: false }, // å¤´éƒ¨ï¼ˆåœ†ï¼‰
                    { x: 300, y: 270, r: 10, isDragging: false }, // é¢ˆéƒ¨
                    { x: 300, y: 330, r: 15, isDragging: false }, // èº¯å¹²ï¼ˆåœ†èƒ–ï¼‰
                    { x: 300, y: 390, r: 12, isDragging: false }, // åèº¯
                    { x: 260, y: 300, r: 10, isDragging: false }, // å·¦è‚©
                    { x: 340, y: 300, r: 10, isDragging: false }, // å³è‚©
                    { x: 220, y: 350, r: 9, isDragging: false },  // å·¦å‰çˆªï¼ˆçŸ­ï¼‰
                    { x: 380, y: 350, r: 9, isDragging: false },  // å³å‰çˆªï¼ˆçŸ­ï¼‰
                    { x: 250, y: 430, r: 10, isDragging: false }, // å·¦åèƒ¯
                    { x: 350, y: 430, r: 10, isDragging: false }, // å³åèƒ¯
                    { x: 220, y: 480, r: 9, isDragging: false },  // å·¦åçˆªï¼ˆçŸ­ï¼‰
                    { x: 380, y: 480, r: 9, isDragging: false },  // å³åçˆªï¼ˆçŸ­ï¼‰
                    { x: 275, y: 210, r: 8, isDragging: false },  // å·¦è€³ï¼ˆé»‘ï¼‰
                    { x: 325, y: 210, r: 8, isDragging: false },  // å³è€³ï¼ˆé»‘ï¼‰
                    { x: 300, y: 420, r: 7, isDragging: false },  // çŸ­å°¾å·´
                ],
                connections: [
                    [0, 1], [1, 2], [2, 3], // èº¯å¹²ï¼ˆåœ†èƒ–ï¼‰
                    [0, 12], [0, 13],       // è€³æœµï¼ˆé»‘ï¼‰
                    [2, 4], [4, 6],         // å·¦å‰è…¿ï¼ˆçŸ­ï¼‰
                    [2, 5], [5, 7],         // å³å‰è…¿ï¼ˆçŸ­ï¼‰
                    [3, 8], [8, 10],        // å·¦åè…¿ï¼ˆçŸ­ï¼‰
                    [3, 9], [9, 11],        // å³åè…¿ï¼ˆçŸ­ï¼‰
                    [3, 14]                 // çŸ­å°¾å·´
                ]
            },
            // é¸¡
            chicken: {
                name: "é¸¡",
                joints: [
                    { x: 300, y: 220, r: 16, isDragging: false }, // å¤´éƒ¨
                    { x: 300, y: 250, r: 8, isDragging: false },  // é¢ˆéƒ¨
                    { x: 300, y: 280, r: 10, isDragging: false }, // èº¯å¹²
                    { x: 300, y: 310, r: 8, isDragging: false },  // èº«ä½“åç«¯
                    { x: 270, y: 270, r: 7, isDragging: false },  // å·¦ç¿…æ ¹
                    { x: 330, y: 270, r: 7, isDragging: false },  // å³ç¿…æ ¹
                    { x: 240, y: 265, r: 6, isDragging: false },  // å·¦ç¿…å°–
                    { x: 360, y: 265, r: 6, isDragging: false },  // å³ç¿…å°–
                    { x: 280, y: 340, r: 7, isDragging: false },  // å·¦è„šæ ¹
                    { x: 320, y: 340, r: 7, isDragging: false },  // å³è„šæ ¹
                    { x: 260, y: 380, r: 6, isDragging: false },  // å·¦è„šçˆª
                    { x: 340, y: 380, r: 6, isDragging: false },  // å³è„šçˆª
                    { x: 300, y: 320, r: 7, isDragging: false },  // å°¾ç¾½æ ¹
                    { x: 300, y: 350, r: 6, isDragging: false },  // å°¾ç¾½ä¸­
                    { x: 300, y: 370, r: 5, isDragging: false },  // å°¾ç¾½å°–
                    { x: 300, y: 200, r: 6, isDragging: false },  // é¸¡å† 
                    { x: 310, y: 225, r: 5, isDragging: false }   // é¸¡å–™
                ],
                connections: [
                    [0, 1], [1, 2], [2, 3], // èº¯å¹²
                    [0, 15], [0, 16],       // é¸¡å† å’Œé¸¡å–™
                    [2, 4], [4, 6],         // å·¦ç¿…è†€
                    [2, 5], [5, 7],         // å³ç¿…è†€
                    [3, 8], [8, 10],        // å·¦è„š
                    [3, 9], [9, 11],        // å³è„š
                    [3, 12], [12, 13], [13, 14] // å°¾ç¾½
                ]
            },
            // ç‰›
            cow: {
                name: "ç‰›",
                joints: [
                    { x: 300, y: 220, r: 22, isDragging: false }, // å¤´éƒ¨
                    { x: 300, y: 280, r: 12, isDragging: false }, // é¢ˆéƒ¨
                    { x: 300, y: 350, r: 15, isDragging: false }, // èº¯å¹²ï¼ˆç²—å£®ï¼‰
                    { x: 300, y: 420, r: 12, isDragging: false }, // åèº¯
                    { x: 250, y: 320, r: 12, isDragging: false }, // å·¦è‚©ï¼ˆç²—å£®ï¼‰
                    { x: 350, y: 320, r: 12, isDragging: false }, // å³è‚©ï¼ˆç²—å£®ï¼‰
                    { x: 210, y: 450, r: 10, isDragging: false }, // å·¦å‰è…¿
                    { x: 380, y: 450, r: 10, isDragging: false }, // å³å‰è…¿
                    { x: 240, y: 460, r: 12, isDragging: false }, // å·¦åèƒ¯ï¼ˆç²—å£®ï¼‰
                    { x: 360, y: 460, r: 12, isDragging: false }, // å³åèƒ¯ï¼ˆç²—å£®ï¼‰
                    { x: 210, y: 550, r: 10, isDragging: false }, // å·¦åçˆª
                    { x: 390, y: 550, r: 10, isDragging: false }, // å³åçˆª
                    { x: 270, y: 200, r: 8, isDragging: false },  // å·¦è§’
                    { x: 330, y: 200, r: 8, isDragging: false },  // å³è§’
                    { x: 300, y: 450, r: 8, isDragging: false },  // å°¾å·´æ ¹
                    { x: 300, y: 490, r: 6, isDragging: false },  // å°¾å·´å°–
                    { x: 320, y: 230, r: 6, isDragging: false }   // ç‰›é¼»
                ],
                connections: [
                    [0, 1], [1, 2], [2, 3], // èº¯å¹²
                    [0, 12], [0, 13],       // è§’
                    [0, 16],                // ç‰›é¼»
                    [2, 4], [4, 6],         // å·¦å‰è…¿ï¼ˆç²—å£®ï¼‰
                    [2, 5], [5, 7],         // å³å‰è…¿ï¼ˆç²—å£®ï¼‰
                    [3, 8], [8, 10],        // å·¦åè…¿ï¼ˆç²—å£®ï¼‰
                    [3, 9], [9, 11],        // å³åè…¿ï¼ˆç²—å£®ï¼‰
                    [3, 14], [14, 15]       // å°¾å·´
                ]
            },
            // è€é¼ 
            mouse: {
                name: "è€é¼ ",
                joints: [
                    { x: 300, y: 220, r: 15, isDragging: false }, // å¤´éƒ¨
                    { x: 300, y: 250, r: 7, isDragging: false },  // é¢ˆéƒ¨
                    { x: 300, y: 280, r: 9, isDragging: false },  // èº¯å¹²
                    { x: 300, y: 310, r: 7, isDragging: false },  // åèº¯
                    { x: 280, y: 260, r: 7, isDragging: false },  // å·¦è‚©
                    { x: 320, y: 260, r: 7, isDragging: false },  // å³è‚©
                    { x: 250, y: 270, r: 6, isDragging: false },  // å·¦å‰çˆª
                    { x: 350, y: 270, r: 6, isDragging: false },  // å³å‰çˆª
                    { x: 280, y: 320, r: 7, isDragging: false },  // å·¦åèƒ¯
                    { x: 320, y: 320, r: 7, isDragging: false },  // å³åèƒ¯
                    { x: 250, y: 350, r: 6, isDragging: false },  // å·¦åçˆª
                    { x: 350, y: 350, r: 6, isDragging: false },  // å³åçˆª
                    { x: 285, y: 210, r: 5, isDragging: false },  // å·¦è€³
                    { x: 315, y: 210, r: 5, isDragging: false },  // å³è€³
                    { x: 300, y: 320, r: 6, isDragging: false },  // å°¾å·´æ ¹
                    { x: 300, y: 360, r: 5, isDragging: false },  // å°¾å·´ä¸­1
                    { x: 300, y: 400, r: 4, isDragging: false },  // å°¾å·´ä¸­2
                    { x: 300, y: 440, r: 3, isDragging: false }   // å°¾å·´å°–
                ],
                connections: [
                    [0, 1], [1, 2], [2, 3], // èº¯å¹²
                    [0, 12], [0, 13],       // è€³æœµ
                    [1, 4], [4, 6],         // å·¦å‰çˆª
                    [1, 5], [5, 7],         // å³å‰çˆª
                    [3, 8], [8, 10],        // å·¦åè…¿
                    [3, 9], [9, 11],        // å³åè…¿
                    [3, 14], [14, 15], [15, 16], [16, 17] // é•¿å°¾å·´
                ]
            }
        };

        // åº”ç”¨çŠ¶æ€
        let appState = {
            selectedIndex: -1, // å½“å‰é€‰ä¸­çš„è§’è‰²ç´¢å¼•ï¼ˆ-1ä¸ºæœªé€‰ä¸­ï¼‰
            isDraggingJoint: false, // æ˜¯å¦åœ¨æ‹–æ‹½å…³èŠ‚
            isDraggingBody: false,  // æ˜¯å¦åœ¨æ‹–æ‹½æ•´ä½“
            isDraggingCanvas: false, // æ˜¯å¦åœ¨æ‹–æ‹½ç”»å¸ƒ
            isSpacePressed: false,   // æ˜¯å¦æŒ‰ä¸‹ç©ºæ ¼é”®
            lastMousePos: { x: 0, y: 0 }, // ä¸Šæ¬¡é¼ æ ‡ä½ç½®
            canvasOffset: { x: 0, y: 0 },  // ç”»å¸ƒåç§»é‡ï¼ˆç”¨äºå¹³ç§»ï¼‰
            canvasScale: 1,               // ç”»å¸ƒç¼©æ”¾æ¯”ä¾‹ï¼ˆ1=100%ï¼‰
            minScale: 0.3,                // æœ€å°ç¼©æ”¾æ¯”ä¾‹
            maxScale: 3                   // æœ€å¤§ç¼©æ”¾æ¯”ä¾‹
        };

        // å­˜å‚¨æ‰€æœ‰è§’è‰²
        let allStickmen = [];

        // æ›´æ–°é€‰æ‹©å™¨é€‰é¡¹
        function updateSelector() {
            const currentValue = stickmanSelector.value;
            
            stickmanSelector.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '-1';
            defaultOption.textContent = 'æœªé€‰æ‹©ä»»ä½•è§’è‰²';
            stickmanSelector.appendChild(defaultOption);
            
            allStickmen.forEach((stickman, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${characterTypes[stickman.type].name} ${index + 1}ï¼ˆ${stickman.color.name}ï¼‰`;
                stickmanSelector.appendChild(option);
            });
            
            if (currentValue === '-1' || appState.selectedIndex === -1) {
                stickmanSelector.value = '-1';
            } else {
                if (appState.selectedIndex < allStickmen.length) {
                    stickmanSelector.value = appState.selectedIndex.toString();
                } else {
                    stickmanSelector.value = '-1';
                }
            }
        }

        // æ›´æ–°é€‰ä¸­æŒ‡ç¤ºå™¨
        function updateSelectedIndicator() {
            if (appState.selectedIndex === -1) {
                selectedIndicator.style.display = 'none';
                return;
            }

            const stickman = allStickmen[appState.selectedIndex];
            if (!stickman) return;

            // è®¡ç®—è§’è‰²è¾¹ç•Œï¼ˆè€ƒè™‘ç”»å¸ƒç¼©æ”¾å’Œå¹³ç§»ï¼‰
            const joints = stickman.joints;
            let minX = Infinity, maxX = -Infinity;
            let minY = Infinity, maxY = -Infinity;

            joints.forEach(joint => {
                const x = (joint.x * stickman.scale + stickman.offset.x) * appState.canvasScale + appState.canvasOffset.x;
                const y = (joint.y * stickman.scale + stickman.offset.y) * appState.canvasScale + appState.canvasOffset.y;
                minX = Math.min(minX, x - joint.r * stickman.scale * appState.canvasScale);
                maxX = Math.max(maxX, x + joint.r * stickman.scale * appState.canvasScale);
                minY = Math.min(minY, y - joint.r * stickman.scale * appState.canvasScale);
                maxY = Math.max(maxY, y + joint.r * stickman.scale * appState.canvasScale);
            });

            // è®¾ç½®æŒ‡ç¤ºå™¨ä½ç½®å’Œå¤§å°å¹¶æ˜¾ç¤º
            selectedIndicator.style.left = `${minX - 10}px`;
            selectedIndicator.style.top = `${minY - 10}px`;
            selectedIndicator.style.width = `${maxX - minX + 20}px`;
            selectedIndicator.style.height = `${maxY - minY + 20}px`;
            selectedIndicator.style.display = 'block';
        }

        // ç»˜åˆ¶çº¿æ®µï¼ˆè€ƒè™‘ç”»å¸ƒç¼©æ”¾å’Œå¹³ç§»ï¼‰
        function drawLine(fromJoint, toJoint, color, scale, offset) {
            ctx.beginPath();
            ctx.moveTo(
                (fromJoint.x * scale + offset.x) * appState.canvasScale + appState.canvasOffset.x,
                (fromJoint.y * scale + offset.y) * appState.canvasScale + appState.canvasOffset.y
            );
            ctx.lineTo(
                (toJoint.x * scale + offset.x) * appState.canvasScale + appState.canvasOffset.x,
                (toJoint.y * scale + offset.y) * appState.canvasScale + appState.canvasOffset.y
            );
            ctx.strokeStyle = color.line;
            ctx.lineWidth = 5 * scale * appState.canvasScale;
            ctx.stroke();
        }

        // ç»˜åˆ¶å•ä¸ªè§’è‰²ï¼ˆè€ƒè™‘ç”»å¸ƒç¼©æ”¾å’Œå¹³ç§»ï¼‰
        function drawSingleStickman(stickman, isSelected) {
            const { color, scale, offset, joints, connections } = stickman;

            // ç»˜åˆ¶èº«ä½“ç»“æ„
            connections.forEach(connection => {
                const fromJoint = joints[connection[0]];
                const toJoint = joints[connection[1]];
                drawLine(fromJoint, toJoint, color, scale, offset);
            });

            // ç»˜åˆ¶å…³èŠ‚ç‚¹
            joints.forEach(joint => {
                ctx.beginPath();
                ctx.arc(
                    (joint.x * scale + offset.x) * appState.canvasScale + appState.canvasOffset.x,
                    (joint.y * scale + offset.y) * appState.canvasScale + appState.canvasOffset.y,
                    joint.r * scale * appState.canvasScale,
                    0,
                    Math.PI * 2
                );
                ctx.fillStyle = joint.isDragging ? color.jointDrag : color.joint;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2 * scale * appState.canvasScale;
                ctx.stroke();
            });

            // é€‰ä¸­çŠ¶æ€ç»˜åˆ¶è™šçº¿æ¡†
            if (isSelected) {
                ctx.strokeStyle = 'rgba(66, 133, 244, 0.7)';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.rect(
                    (Math.min(...joints.map(j => j.x)) - 20) * scale * appState.canvasScale + offset.x * appState.canvasScale + appState.canvasOffset.x,
                    (Math.min(...joints.map(j => j.y)) - 20) * scale * appState.canvasScale + offset.y * appState.canvasScale + appState.canvasOffset.y,
                    (Math.max(...joints.map(j => j.x)) - Math.min(...joints.map(j => j.x)) + 40) * scale * appState.canvasScale,
                    (Math.max(...joints.map(j => j.y)) - Math.min(...joints.map(j => j.y)) + 40) * scale * appState.canvasScale
                );
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }

        // ç»˜åˆ¶ç”»å¸ƒè¾¹ç•Œæ¡†
        function drawCanvasBorder() {
            ctx.save();
            
            // åº”ç”¨ç”»å¸ƒå˜æ¢
            ctx.translate(appState.canvasOffset.x, appState.canvasOffset.y);
            ctx.scale(appState.canvasScale, appState.canvasScale);
            
            // ç»˜åˆ¶è¾¹ç•Œæ¡†
            ctx.strokeStyle = '#999';
            ctx.lineWidth = 2 / appState.canvasScale; // çº¿å®½éšç¼©æ”¾è°ƒæ•´
            ctx.setLineDash([5 / appState.canvasScale, 5 / appState.canvasScale]);
            ctx.strokeRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶å››ä¸ªè§’çš„æ ‡è®°
            const cornerSize = 10 / appState.canvasScale;
            ctx.setLineDash([]);
            ctx.lineWidth = 2 / appState.canvasScale;
            
            // å·¦ä¸Šè§’
            ctx.beginPath();
            ctx.moveTo(0, cornerSize);
            ctx.lineTo(0, 0);
            ctx.lineTo(cornerSize, 0);
            ctx.stroke();
            
            // å³ä¸Šè§’
            ctx.beginPath();
            ctx.moveTo(canvas.width - cornerSize, 0);
            ctx.lineTo(canvas.width, 0);
            ctx.lineTo(canvas.width, cornerSize);
            ctx.stroke();
            
            // å·¦ä¸‹è§’
            ctx.beginPath();
            ctx.moveTo(0, canvas.height - cornerSize);
            ctx.lineTo(0, canvas.height);
            ctx.lineTo(cornerSize, canvas.height);
            ctx.stroke();
            
            // å³ä¸‹è§’
            ctx.beginPath();
            ctx.moveTo(canvas.width - cornerSize, canvas.height);
            ctx.lineTo(canvas.width, canvas.height);
            ctx.lineTo(canvas.width, canvas.height - cornerSize);
            ctx.stroke();
            
            ctx.restore();
        }

        // ç»˜åˆ¶æ‰€æœ‰å…ƒç´ ï¼ˆå…ˆèƒŒæ™¯ï¼Œå†è§’è‰²ï¼Œæœ€åè¾¹ç•Œæ¡†ï¼‰
        function drawAllStickmen() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶æ‰€æœ‰è§’è‰²
            allStickmen.forEach((stickman, index) => {
                drawSingleStickman(stickman, index === appState.selectedIndex);
            });
            
            // æœ€åç»˜åˆ¶ç”»å¸ƒè¾¹ç•Œæ¡†
            drawCanvasBorder();
            
            updateSelectedIndicator();
        }

        // åæ ‡è½¬æ¢ï¼šç”»å¸ƒæ˜¾ç¤ºåæ ‡ -> å®é™…ä¸–ç•Œåæ ‡ï¼ˆè€ƒè™‘ç¼©æ”¾å’Œå¹³ç§»ï¼‰
        function canvasToWorld(x, y) {
            return {
                x: (x - appState.canvasOffset.x) / appState.canvasScale,
                y: (y - appState.canvasOffset.y) / appState.canvasScale
            };
        }

        // åæ ‡è½¬æ¢ï¼šä¸–ç•Œåæ ‡ -> è§’è‰²æœ¬åœ°åæ ‡
        function worldToLocal(x, y, stickman) {
            return {
                x: (x - stickman.offset.x) / stickman.scale,
                y: (y - stickman.offset.y) / stickman.scale
            };
        }

        // æ£€æµ‹ç‚¹æ˜¯å¦åœ¨å…³èŠ‚å†…ï¼ˆè€ƒè™‘ç”»å¸ƒç¼©æ”¾å’Œå¹³ç§»ï¼‰
        function isPointInJoint(joint, x, y, scale, offset) {
            const worldPos = canvasToWorld(x, y);
            const dx = worldPos.x - (joint.x * scale + offset.x);
            const dy = worldPos.y - (joint.y * scale + offset.y);
            return dx * dx + dy * dy <= (joint.r * scale) * (joint.r * scale);
        }

        // æ£€æµ‹ç‚¹æ˜¯å¦åœ¨è§’è‰²èŒƒå›´å†…ï¼ˆéå…³èŠ‚åŒºåŸŸï¼‰
        function isPointInStickmanArea(x, y, stickman) {
            const worldPos = canvasToWorld(x, y);
            const joints = stickman.joints;
            const minX = Math.min(...joints.map(j => j.x)) * stickman.scale + stickman.offset.x;
            const maxX = Math.max(...joints.map(j => j.x)) * stickman.scale + stickman.offset.x;
            const minY = Math.min(...joints.map(j => j.y)) * stickman.scale + stickman.offset.y;
            const maxY = Math.max(...joints.map(j => j.y)) * stickman.scale + stickman.offset.y;

            // åœ¨è§’è‰²èŒƒå›´å†…ï¼Œä½†ä¸åœ¨ä»»ä½•å…³èŠ‚ä¸Š
            if (worldPos.x >= minX - 20 && worldPos.x <= maxX + 20 && 
                worldPos.y >= minY - 20 && worldPos.y <= maxY + 20) {
                return !joints.some(joint => isPointInJoint(joint, x, y, stickman.scale, stickman.offset));
            }
            return false;
        }

        // æ£€æµ‹ç‚¹æ˜¯å¦åœ¨ä»»ä½•è§’è‰²ä¸Š
        function isPointOnAnyStickman(x, y) {
            for (const stickman of allStickmen) {
                // æ£€æŸ¥æ˜¯å¦åœ¨å…³èŠ‚ä¸Š
                if (stickman.joints.some(joint => isPointInJoint(joint, x, y, stickman.scale, stickman.offset))) {
                    return true;
                }
                // æ£€æŸ¥æ˜¯å¦åœ¨ä¸»ä½“åŒºåŸŸ
                if (isPointInStickmanArea(x, y, stickman)) {
                    return true;
                }
            }
            return false;
        }

        // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            appState.lastMousePos = { x, y };
            appState.isDraggingJoint = false;
            appState.isDraggingBody = false;
            appState.isDraggingCanvas = false;
            appState.isDraggingBackground = false;

            // å¦‚æœæŒ‰ä¸‹äº†ç©ºæ ¼é”®ï¼Œè¿›å…¥ç”»å¸ƒæ‹–æ‹½æ¨¡å¼
            if (appState.isSpacePressed) {
                appState.isDraggingCanvas = true;
                canvas.classList.add('dragging');
                updateStatus('æ­£åœ¨æ‹–æ‹½ç”»å¸ƒ...');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†ç©ºç™½åŒºåŸŸï¼ˆå–æ¶ˆé€‰ä¸­ï¼‰
            if (!isPointOnAnyStickman(x, y)) {
                appState.selectedIndex = -1; // é‡ç½®ä¸ºæœªé€‰ä¸­
                allStickmen.forEach(s => s.joints.forEach(j => j.isDragging = false));
                updateSelector();
                updateStatus('çŠ¶æ€ï¼šæœªé€‰æ‹©ä»»ä½•è§’è‰²ï¼ˆç‚¹å‡»è§’è‰²å¼€å§‹æ“ä½œï¼‰');
                drawAllStickmen();
                return;
            }

            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†ä»»ä½•è§’è‰²çš„å…³èŠ‚
            let jointClicked = false;
            allStickmen.forEach((stickman, index) => {
                stickman.joints.forEach(joint => {
                    if (isPointInJoint(joint, x, y, stickman.scale, stickman.offset)) {
                        // é‡ç½®æ‰€æœ‰å…³èŠ‚æ‹–æ‹½çŠ¶æ€
                        allStickmen.forEach(s => s.joints.forEach(j => j.isDragging = false));
                        joint.isDragging = true;
                        appState.selectedIndex = index;
                        appState.isDraggingJoint = true;
                        jointClicked = true;
                        stickmanSelector.value = index;
                        updateStatus(`æ­£åœ¨è°ƒæ•´${characterTypes[stickman.type].name} ${index + 1}çš„å…³èŠ‚`);
                    }
                });
            });

            // å¦‚æœæ²¡ç‚¹å‡»å…³èŠ‚ï¼Œæ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†è§’è‰²åŒºåŸŸ
            if (!jointClicked) {
                for (let i = allStickmen.length - 1; i >= 0; i--) {
                    const stickman = allStickmen[i];
                    if (isPointInStickmanArea(x, y, stickman)) {
                        appState.selectedIndex = i;
                        appState.isDraggingBody = true;
                        stickmanSelector.value = i;
                        canvas.classList.add('dragging');
                        updateStatus(`æ­£åœ¨ç§»åŠ¨${characterTypes[stickman.type].name} ${i + 1}`);
                        break;
                    }
                }
            }

            drawAllStickmen();
        });

        // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const dx = x - appState.lastMousePos.x;
            const dy = y - appState.lastMousePos.y;
            appState.lastMousePos = { x, y };

            // æ‹–æ‹½ç”»å¸ƒ
            if (appState.isDraggingCanvas) {
                appState.canvasOffset.x += dx;
                appState.canvasOffset.y += dy;
                drawAllStickmen();
                return;
            }

            // æœªé€‰ä¸­ä»»ä½•è§’è‰²æ—¶ä¸å¤„ç†å…¶ä»–ç§»åŠ¨
            if (appState.selectedIndex === -1) return;

            const selectedStickman = allStickmen[appState.selectedIndex];
            if (!selectedStickman) return;

            // æ‹–æ‹½å…³èŠ‚
            if (appState.isDraggingJoint) {
                const worldPos = canvasToWorld(x, y);
                const localPos = worldToLocal(worldPos.x, worldPos.y, selectedStickman);
                selectedStickman.joints.forEach(joint => {
                    if (joint.isDragging) {
                        joint.x = localPos.x;
                        joint.y = localPos.y;
                    }
                });
            }
            // æ‹–æ‹½æ•´ä½“
            else if (appState.isDraggingBody) {
                // è½¬æ¢é¼ æ ‡ç§»åŠ¨å¢é‡åˆ°ä¸–ç•Œåæ ‡
                const worldDx = dx / appState.canvasScale;
                const worldDy = dy / appState.canvasScale;
                selectedStickman.offset.x += worldDx;
                selectedStickman.offset.y += worldDy;
            }

            drawAllStickmen();
        });

        // é¼ æ ‡æ¾å¼€/ç¦»å¼€äº‹ä»¶
        ['mouseup', 'mouseleave'].forEach(event => {
            canvas.addEventListener(event, () => {
                // ç»“æŸæ‰€æœ‰æ‹–æ‹½çŠ¶æ€
                allStickmen.forEach(stickman => {
                    stickman.joints.forEach(joint => {
                        joint.isDragging = false;
                    });
                });
                appState.isDraggingJoint = false;
                appState.isDraggingBody = false;
                appState.isDraggingCanvas = false;
                canvas.classList.remove('dragging');
                
                // æ›´æ–°çŠ¶æ€æ–‡æœ¬
                if (appState.selectedIndex === -1) {
                    updateStatus('çŠ¶æ€ï¼šæœªé€‰æ‹©ä»»ä½•è§’è‰²ï¼ˆç‚¹å‡»è§’è‰²å¼€å§‹æ“ä½œï¼‰');
                } else {
                    const selectedStickman = allStickmen[appState.selectedIndex];
                    updateStatus(`å·²é€‰æ‹©${characterTypes[selectedStickman.type].name} ${appState.selectedIndex + 1} | ç”»å¸ƒç¼©æ”¾: ${Math.round(appState.canvasScale * 100)}%`);
                }
                
                drawAllStickmen();
            });
        });

        // é¼ æ ‡æ»šè½®äº‹ä»¶ï¼ˆåŒºåˆ†è§’è‰²ç¼©æ”¾ã€ç”»å¸ƒç¼©æ”¾å’ŒèƒŒæ™¯ç¼©æ”¾ï¼‰
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            // å¦‚æœé€‰ä¸­äº†è§’è‰²ä¸”é¼ æ ‡åœ¨è§’è‰²ä¸Šï¼Œåˆ™ç¼©æ”¾è§’è‰²
            if (appState.selectedIndex !== -1) {
                const selectedStickman = allStickmen[appState.selectedIndex];
                if (selectedStickman && isPointOnAnyStickman(mouseX, mouseY)) {
                    // è§’è‰²ç¼©æ”¾é€»è¾‘
                    if (e.deltaY < 0) {
                        selectedStickman.scale = Math.min(selectedStickman.scale + 0.1, 3);
                    } else {
                        selectedStickman.scale = Math.max(selectedStickman.scale - 0.1, 0.3);
                    }
                    updateStatus(`${characterTypes[selectedStickman.type].name} ${appState.selectedIndex + 1} ç¼©æ”¾æ¯”ä¾‹ï¼š${selectedStickman.scale.toFixed(1)} | ç”»å¸ƒç¼©æ”¾: ${Math.round(appState.canvasScale * 100)}%`);
                    drawAllStickmen();
                    return;
                }
            }

            // å¦åˆ™ç¼©æ”¾ç”»å¸ƒ
            const mouseWorldPos = canvasToWorld(mouseX, mouseY);
            
            // æ ¹æ®æ»šè½®æ–¹å‘ç¼©æ”¾ç”»å¸ƒ
            if (e.deltaY < 0) {
                appState.canvasScale = Math.min(appState.canvasScale + 0.1, appState.maxScale);
            } else {
                appState.canvasScale = Math.max(appState.canvasScale - 0.1, appState.minScale);
            }

            // è°ƒæ•´ç”»å¸ƒåç§»ï¼Œä½¿ç¼©æ”¾å›´ç»•é¼ æ ‡ä½ç½®è¿›è¡Œ
            appState.canvasOffset.x = mouseX - mouseWorldPos.x * appState.canvasScale;
            appState.canvasOffset.y = mouseY - mouseWorldPos.y * appState.canvasScale;

            updateZoomDisplay();
            updateStatus(appState.selectedIndex === -1 
                ? `ç”»å¸ƒç¼©æ”¾: ${Math.round(appState.canvasScale * 100)}% | æœªé€‰æ‹©è§’è‰²`
                : `å·²é€‰æ‹©${characterTypes[allStickmen[appState.selectedIndex].type].name} ${appState.selectedIndex + 1} | ç”»å¸ƒç¼©æ”¾: ${Math.round(appState.canvasScale * 100)}%`);
            drawAllStickmen();
        }, { passive: false });

        // é”®ç›˜äº‹ä»¶ï¼ˆå¤„ç†ç©ºæ ¼é”®å’ŒAlté”®ï¼‰
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                appState.isSpacePressed = true;
                canvas.style.cursor = 'grab';
            }
            
            // é”®ç›˜æ–¹å‘é”®ç§»åŠ¨é€‰ä¸­è§’è‰²
            if (appState.selectedIndex !== -1 && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                const selectedStickman = allStickmen[appState.selectedIndex];
                const step = 10 / appState.canvasScale; // æ­¥é•¿è¡¥å¿ç”»å¸ƒç¼©æ”¾
                switch(e.key) {
                    case 'ArrowUp': selectedStickman.offset.y -= step; break;
                    case 'ArrowDown': selectedStickman.offset.y += step; break;
                    case 'ArrowLeft': selectedStickman.offset.x -= step; break;
                    case 'ArrowRight': selectedStickman.offset.x += step; break;
                }
                drawAllStickmen();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.code === 'Space') {
                appState.isSpacePressed = false;
                canvas.style.cursor = '';
            }
        });

        // æ›´æ–°ç¼©æ”¾æ˜¾ç¤º
        function updateZoomDisplay() {
            zoomLevelDisplay.textContent = `${Math.round(appState.canvasScale * 100)}%`;
        }

        // æ›´æ–°çŠ¶æ€æ–‡æœ¬
        function updateStatus(text) {
            statusText.textContent = text;
        }

        // å¢åŠ è§’è‰²æŒ‰é’®
        addStickmanBtn.addEventListener('click', () => {
            const type = typeSelector.value;
            const typeConfig = characterTypes[type];
            const colorIndex = allStickmen.length % stickmanColors.length;
            
            // æ–°è§’è‰²ä½ç½®åç§»ï¼ˆç½‘æ ¼æ’åˆ—ï¼Œé¿å…é‡å ï¼‰
            const col = allStickmen.length % 4; // 4åˆ—å¸ƒå±€
            const row = Math.floor(allStickmen.length / 4);
            const offsetX = 250 * col;
            const offsetY = 350 * row;

            allStickmen.push({
                type: type,
                joints: JSON.parse(JSON.stringify(typeConfig.joints)),
                connections: typeConfig.connections,
                color: stickmanColors[colorIndex],
                scale: 1,
                offset: { x: offsetX, y: offsetY },
                initialOffset: { x: offsetX, y: offsetY } // è®°å½•åˆå§‹ä½ç½®
            });

            // æ·»åŠ åè‡ªåŠ¨é€‰ä¸­æ–°è§’è‰²
            appState.selectedIndex = allStickmen.length - 1;
            updateSelector();
            updateStatus(`å·²æ·»åŠ å¹¶é€‰æ‹©${typeConfig.name} ${allStickmen.length} | ç”»å¸ƒç¼©æ”¾: ${Math.round(appState.canvasScale * 100)}%`);
            drawAllStickmen();
        });

        // å§¿æ€å½’é›¶æŒ‰é’®
        resetBtn.addEventListener('click', () => {
            if (appState.selectedIndex === -1) {
                updateStatus('çŠ¶æ€ï¼šè¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²å†è¿›è¡Œå½’é›¶æ“ä½œ');
                return;
            }

            const stickman = allStickmen[appState.selectedIndex];
            if (stickman) {
                // æ¢å¤åˆå§‹å…³èŠ‚ã€ç¼©æ”¾å’Œä½ç½®
                const typeConfig = characterTypes[stickman.type];
                const resetJoints = JSON.parse(JSON.stringify(typeConfig.joints));
                stickman.joints = resetJoints;
                stickman.scale = 1;
                stickman.offset = { ...stickman.initialOffset }; // æ¢å¤åˆ°åˆ›å»ºæ—¶çš„ä½ç½®
                updateStatus(`${characterTypes[stickman.type].name} ${appState.selectedIndex + 1} å·²æ¢å¤åˆå§‹å§¿æ€ | ç”»å¸ƒç¼©æ”¾: ${Math.round(appState.canvasScale * 100)}%`);
                drawAllStickmen();
            }
        });

        // åˆ é™¤è§’è‰²æŒ‰é’®
        deleteStickmanBtn.addEventListener('click', () => {
            if (appState.selectedIndex === -1) {
                updateStatus('çŠ¶æ€ï¼šè¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²å†è¿›è¡Œåˆ é™¤æ“ä½œ');
                return;
            }
            
            if (allStickmen.length <= 1) {
                updateStatus('çŠ¶æ€ï¼šè‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªè§’è‰²ï¼Œæ— æ³•åˆ é™¤');
                return;
            }
            
            const stickman = allStickmen[appState.selectedIndex];
            if (confirm(`ç¡®å®šè¦åˆ é™¤${characterTypes[stickman.type].name} ${appState.selectedIndex + 1}å—ï¼Ÿ`)) {
                allStickmen.splice(appState.selectedIndex, 1);
                appState.selectedIndex = -1;
                updateSelector();
                updateStatus(`å·²åˆ é™¤é€‰ä¸­çš„è§’è‰² | ç”»å¸ƒç¼©æ”¾: ${Math.round(appState.canvasScale * 100)}%`);
                drawAllStickmen();
            }
        });

        // è°ƒæ•´ç”»å¸ƒå¤§å°æŒ‰é’®
        resizeCanvasBtn.addEventListener('click', () => {
            const width = Math.max(300, parseInt(canvasWidthInput.value) || 1920);
            const height = Math.max(200, parseInt(canvasHeightInput.value) || 1080);
            
            canvas.width = width;
            canvas.height = height;
            updateStatus(`ç”»å¸ƒå·²è°ƒæ•´ä¸º ${width}Ã—${height} åƒç´  | ç”»å¸ƒç¼©æ”¾: ${Math.round(appState.canvasScale * 100)}%`);
            canvasWidthInput.value = width;
            canvasHeightInput.value = height;
            drawAllStickmen();
        });

        // ç”»å¸ƒæ”¾å¤§æŒ‰é’®
        zoomInBtn.addEventListener('click', () => {
            if (appState.canvasScale < appState.maxScale) {
                appState.canvasScale += 0.1;
                updateZoomDisplay();
                updateStatus(appState.selectedIndex === -1 
                    ? `ç”»å¸ƒç¼©æ”¾: ${Math.round(appState.canvasScale * 100)}% | æœªé€‰æ‹©è§’è‰²`
                    : `å·²é€‰æ‹©${characterTypes[allStickmen[appState.selectedIndex].type].name} ${appState.selectedIndex + 1} | ç”»å¸ƒç¼©æ”¾: ${Math.round(appState.canvasScale * 100)}%`);
                drawAllStickmen();
            }
        });

        // ç”»å¸ƒç¼©å°æŒ‰é’®
        zoomOutBtn.addEventListener('click', () => {
            if (appState.canvasScale > appState.minScale) {
                appState.canvasScale -= 0.1;
                updateZoomDisplay();
                updateStatus(appState.selectedIndex === -1 
                    ? `ç”»å¸ƒç¼©æ”¾: ${Math.round(appState.canvasScale * 100)}% | æœªé€‰æ‹©è§’è‰²`
                    : `å·²é€‰æ‹©${characterTypes[allStickmen[appState.selectedIndex].type].name} ${appState.selectedIndex + 1} | ç”»å¸ƒç¼©æ”¾: ${Math.round(appState.canvasScale * 100)}%`);
                drawAllStickmen();
            }
        });

        // é‡ç½®è§†å›¾æŒ‰é’®
        resetViewBtn.addEventListener('click', () => {
            appState.canvasScale = 1;
            appState.canvasOffset = { x: 0, y: 0 };
            updateZoomDisplay();
            updateStatus(appState.selectedIndex === -1 
                ? `ç”»å¸ƒå·²é‡ç½®ä¸ºé»˜è®¤è§†å›¾ | æœªé€‰æ‹©è§’è‰²`
                : `å·²é€‰æ‹©${characterTypes[allStickmen[appState.selectedIndex].type].name} ${appState.selectedIndex + 1} | ç”»å¸ƒå·²é‡ç½®ä¸ºé»˜è®¤è§†å›¾`);
            drawAllStickmen();
        });

        // å¯¼å‡ºå›¾åƒæŒ‰é’®ï¼ˆå‚è€ƒç”»æ¿çš„å®ç°æ–¹å¼ï¼‰
        exportImageBtn.addEventListener('click', async () => {
            // é˜²æ­¢é‡å¤ç‚¹å‡»
            if (isExporting) {
                console.log('[stickman-editor] æ­£åœ¨å¯¼å‡ºä¸­ï¼Œè¯·ç¨å€™...');
                updateStatus('æ­£åœ¨å¯¼å‡ºä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }
            
            try {
                isExporting = true;
                exportImageBtn.disabled = true;
                exportImageBtn.style.opacity = '0.6';
                exportImageBtn.style.cursor = 'not-allowed';
                
                console.log('[stickman-editor] å¯¼å‡ºå›¾åƒæŒ‰é’®è¢«ç‚¹å‡»');
                updateStatus('æ­£åœ¨å¯¼å‡ºå›¾åƒ...');
                
                // åˆ›å»ºä¸´æ—¶canvasç”¨äºå¯¼å‡ºï¼ˆä¸åŒ…å«è¾¹ç•Œæ¡†ï¼‰
                const exportCanvas = document.createElement('canvas');
                exportCanvas.width = canvas.width;
                exportCanvas.height = canvas.height;
                const exportCtx = exportCanvas.getContext('2d');
                
                // è®¾ç½®ç™½è‰²èƒŒæ™¯
                exportCtx.fillStyle = '#ffffff';
                exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
                
                // ç»˜åˆ¶æ‰€æœ‰è§’è‰²ï¼ˆä½¿ç”¨åŸå§‹å°ºå¯¸ï¼Œä¸è€ƒè™‘è§†å›¾ç¼©æ”¾ï¼‰
                allStickmen.forEach((stickman) => {
                    const { color, scale, offset, joints, connections } = stickman;
                    
                    // ç»˜åˆ¶èº«ä½“ç»“æ„
                    connections.forEach(connection => {
                        const fromJoint = joints[connection[0]];
                        const toJoint = joints[connection[1]];
                        exportCtx.beginPath();
                        exportCtx.moveTo(
                            fromJoint.x * scale + offset.x,
                            fromJoint.y * scale + offset.y
                        );
                        exportCtx.lineTo(
                            toJoint.x * scale + offset.x,
                            toJoint.y * scale + offset.y
                        );
                        exportCtx.strokeStyle = color.line;
                        exportCtx.lineWidth = 5 * scale;
                        exportCtx.stroke();
                    });
                    
                    // ç»˜åˆ¶å…³èŠ‚ç‚¹
                    joints.forEach(joint => {
                        exportCtx.beginPath();
                        exportCtx.arc(
                            joint.x * scale + offset.x,
                            joint.y * scale + offset.y,
                            joint.r * scale,
                            0,
                            Math.PI * 2
                        );
                        exportCtx.fillStyle = color.joint;
                        exportCtx.fill();
                        exportCtx.strokeStyle = '#fff';
                        exportCtx.lineWidth = 2 * scale;
                        exportCtx.stroke();
                    });
                });
                
                // ä½¿ç”¨ toDataURL è·å–å›¾åƒæ•°æ®ï¼ˆå‚è€ƒç”»æ¿çš„æ–¹å¼ï¼‰
                const imageDataUrl = exportCanvas.toDataURL('image/png');
                
                // ä½¿ç”¨postMessageå‘é€æ¶ˆæ¯ç»™çˆ¶çª—å£ï¼ˆComfyUIï¼‰
                if (window.parent && window.parent !== window) {
                    // å‘é€æ¶ˆæ¯ç»™çˆ¶çª—å£
                    console.log('[stickman-editor] å‡†å¤‡å‘é€æ¶ˆæ¯ç»™çˆ¶çª—å£ï¼Œæ•°æ®å¤§å°:', imageDataUrl.length);
                    window.parent.postMessage({
                        type: 'exportImage',
                        imageDataUrl: imageDataUrl
                    }, '*'); // ä½¿ç”¨ '*' å› ä¸ºå¯èƒ½è·¨åŸŸ
                    
                    updateStatus(`å›¾åƒå·²å¯¼å‡ºå¹¶æ·»åŠ åˆ°ComfyUIå·¥ä½œæµ (${canvas.width}Ã—${canvas.height}px)`);
                    console.log('[stickman-editor] âœ“ å·²å‘é€å¯¼å‡ºå›¾åƒæ¶ˆæ¯ç»™çˆ¶çª—å£');
                } else {
                    // å¦‚æœä¸åœ¨iframeä¸­ï¼Œåˆ™ä¸‹è½½æ–‡ä»¶
                    const blob = await (await fetch(imageDataUrl)).blob();
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `stickman-editor-${Date.now()}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    updateStatus(`å›¾åƒå·²å¯¼å‡º (${canvas.width}Ã—${canvas.height}px)`);
                }
                
            } catch (error) {
                console.error('[stickman-editor] å¯¼å‡ºå›¾åƒå¤±è´¥:', error);
                console.error('[stickman-editor] é”™è¯¯å †æ ˆ:', error.stack);
                updateStatus('å¯¼å‡ºå›¾åƒå¤±è´¥ï¼Œè¯·é‡è¯•: ' + error.message);
            } finally {
                // ç¡®ä¿åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½é‡ç½®å¯¼å‡ºçŠ¶æ€
                isExporting = false;
                exportImageBtn.disabled = false;
                exportImageBtn.style.opacity = '1';
                exportImageBtn.style.cursor = 'pointer';
                console.log('[stickman-editor] å¯¼å‡ºçŠ¶æ€å·²é‡ç½®');
            }
        });

        // é€‰æ‹©å™¨å˜åŒ–äº‹ä»¶
        stickmanSelector.addEventListener('change', (e) => {
            const selected = parseInt(e.target.value);
            appState.selectedIndex = selected;
            
            if (selected === -1) {
                updateStatus(`çŠ¶æ€ï¼šæœªé€‰æ‹©ä»»ä½•è§’è‰² | ç”»å¸ƒç¼©æ”¾: ${Math.round(appState.canvasScale * 100)}%`);
            } else {
                const selectedStickman = allStickmen[selected];
                updateStatus(`å·²é€‰æ‹©${characterTypes[selectedStickman.type].name} ${selected + 1} | ç”»å¸ƒç¼©æ”¾: ${Math.round(appState.canvasScale * 100)}%`);
            }
            
            drawAllStickmen();
        });

        // çª—å£å¤§å°å˜åŒ–æ—¶è‡ªåŠ¨è°ƒæ•´ç”»å¸ƒå®¹å™¨å¤§å°
        function resizeCanvasContainer() {
            const headerHeight = document.querySelector('.header').offsetHeight;
            const controlPanelHeight = document.querySelector('.control-panel').offsetHeight;
            const windowHeight = window.innerHeight;
            
            const canvasContainerHeight = windowHeight - headerHeight - controlPanelHeight;
            canvasContainer.style.height = `${canvasContainerHeight}px`;
        }

        // åˆå§‹åŒ–çª—å£å¤§å°è°ƒæ•´äº‹ä»¶
        window.addEventListener('resize', resizeCanvasContainer);
        
        // åˆå§‹åŒ–
        resizeCanvasContainer();
        updateSelector();
        updateZoomDisplay();
        updateStatus('çŠ¶æ€ï¼šæœªé€‰æ‹©ä»»ä½•è§’è‰²ï¼ˆç‚¹å‡»"å¢åŠ è§’è‰²"æ·»åŠ è§’è‰²ï¼‰');
        drawAllStickmen();
    </script>
</body>
</html>